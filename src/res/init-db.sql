-- init-db.sql
-- Выполняется один раз при инициализации кластера Postgres (docker-entrypoint-initdb.d)
-- Требует существующих таблиц из миграций: positions, teams, employees, status_history

BEGIN;
-- Отключаем проверку FK/триггеров в рамках ТЕКУЩЕЙ транзакции
SET LOCAL session_replication_role = 'replica';

-- ===== 1) POSITIONS =====
INSERT INTO positions (id, title)
VALUES
    ('0f5d5d50-0000-0000-0000-000000000001', 'Генеральный директор'),
    ('0f5d5d50-0000-0000-0000-000000000002', 'Руководитель продуктового офиса'),
    ('0f5d5d50-0000-0000-0000-000000000003', 'Ведущий UX/UI дизайнер'),
    ('0f5d5d50-0000-0000-0000-000000000004', 'Руководитель группы разработки'),
    ('0f5d5d50-0000-0000-0000-000000000005', 'Технический директор'),
    ('0f5d5d50-0000-0000-0000-000000000006', 'Аккаунт-менеджер'),
    ('0f5d5d50-0000-0000-0000-000000000007', 'HR-менеджер'),
    ('0f5d5d50-0000-0000-0000-000000000008', 'Data Scientist'),
    ('0f5d5d50-0000-0000-0000-000000000009', 'Продакт-менеджер'),
    ('0f5d5d50-0000-0000-0000-000000000010', 'Frontend разработчик')
ON CONFLICT (id) DO NOTHING;






-- ===== 2) TEAMS =====
-- ======================================================================
--  УРОВЕНЬ 3 — ЮРИДИЧЕСКИЕ ЛИЦА (parent_id = NULL)
-- ======================================================================

INSERT INTO teams (id, name, parent_id, leader_employee_id) VALUES
('018f3c80-8b4e-7f63-b2ed-8e91bd776701', 'ТриниДата', NULL, '018f3c80-8b4e-7f63-b2ed-8e91bd7767f1'),
('018f3c80-8b4e-7f63-b2ed-8e91bd776702', 'ВНЕ ОЧЕРЕДИ', NULL, '018f3c80-8b4e-7f63-b2ed-8e91bd7767f2'),
('018f3c80-8b4e-7f63-b2ed-8e91bd776703', 'ФТ-СОФТ', NULL, '018f3c80-8b4e-7f63-b2ed-8e91bd7767f3'),
('018f3c80-8b4e-7f63-b2ed-8e91bd776704', 'КИТ', NULL, '018f3c80-8b4e-7f63-b2ed-8e91bd7767f4'),
('018f3c80-8b4e-7f63-b2ed-8e91bd776705', 'КИТ.Р', NULL, '018f3c80-8b4e-7f63-b2ed-8e91bd7767f5'),
('018f3c80-8b4e-7f63-b2ed-8e91bd776706', 'Сайберлимфа', NULL, '018f3c80-8b4e-7f63-b2ed-8e91bd7767f6'),
('018f3c80-8b4e-7f63-b2ed-8e91bd776707', 'Витропс', NULL, '018f3c80-8b4e-7f63-b2ed-8e91bd7767f7');



-- ======================================================================
--  УРОВЕНЬ 4 — ТРИНИДАТА
-- ======================================================================

INSERT INTO teams (id, name, parent_id, leader_employee_id) VALUES
('018f3c80-8b4f-7b11-b403-e3f1a7087701', 'Основное подразделение',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776701', '018f3c80-8b4f-7b11-b403-e3f1a70877f1');



-- ======================================================================
--  УРОВЕНЬ 4 — ВНЕ ОЧЕРЕДИ
-- ======================================================================

INSERT INTO teams (id, name, parent_id, leader_employee_id) VALUES
('018f3c80-8b4f-7b11-b403-e3f1a7087702', 'Основное подразделение',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776702', '018f3c80-8b4f-7b11-b403-e3f1a70877f2'),

('018f3c80-8b4f-7b11-b403-e3f1a7087703', 'Отдел продуктовой разработки',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776702', '018f3c80-8b4f-7b11-b403-e3f1a70877f3');



-- ======================================================================
--  УРОВЕНЬ 4 — ФТ-СОФТ
-- ======================================================================

INSERT INTO teams (id, name, parent_id, leader_employee_id) VALUES
('018f3c80-8b4f-7b11-b403-e3f1a7087704', 'Администрация',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776703', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d106'),

('018f3c80-8b4f-7b11-b403-e3f1a7087705', 'Отдел продуктовой разработки 1',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776703', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d105'),

('018f3c80-8b4f-7b11-b403-e3f1a7087706', 'Отдел продуктовой разработки 2',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776703', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d101'),

('018f3c80-8b4f-7b11-b403-e3f1a7087707', 'Отдел заказной разработки',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776703', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d104'),

('018f3c80-8b4f-7b11-b403-e3f1a7087708', 'Основное подразделение',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776703', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d102'),

('018f3c80-8b4f-7b11-b403-e3f1a7087709', 'Направление аналитики и документации',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776703', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d103');



-- ======================================================================
--  УРОВЕНЬ 4 — КИТ
-- ======================================================================

INSERT INTO teams (id, name, parent_id, leader_employee_id) VALUES
('018f3c80-8b4f-7b11-b403-e3f1a7087710', 'Администрация',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776704', '018f3c80-8b4f-7b11-b403-e3f1a7087801'),

('018f3c80-8b4f-7b11-b403-e3f1a7087711', 'Департамент консалтинга',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776704', '018f3c80-8b4f-7b11-b403-e3f1a7087802'),

('018f3c80-8b4f-7b11-b403-e3f1a7087712', 'Отдел сопровождения информационных систем',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776704', '018f3c80-8b4f-7b11-b403-e3f1a7087803'),

('018f3c80-8b4f-7b11-b403-e3f1a7087713', 'Департамент по работе с иностранными заказчиками',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776704', '018f3c80-8b4f-7b11-b403-e3f1a7087804');



-- ======================================================================
--  УРОВЕНЬ 4 — КИТ.Р
-- ======================================================================

INSERT INTO teams (id, name, parent_id, leader_employee_id) VALUES
('018f3c80-8b4f-7b11-b403-e3f1a7087714', 'Администрация',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776705', '018f3c80-8b4f-7b11-b403-e3f1a7087805'),

('018f3c80-8b4f-7b11-b403-e3f1a7087715', 'Департамент разработки',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776705', '018f3c80-8b4f-7b11-b403-e3f1a7087806'),

('018f3c80-8b4f-7b11-b403-e3f1a7087716', 'Департамент кибербезопасности',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776705', '018f3c80-8b4f-7b11-b403-e3f1a7087807'),

('018f3c80-8b4f-7b11-b403-e3f1a7087717', 'Департамент маркетинга',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776705', '018f3c80-8b4f-7b11-b403-e3f1a7087808');



-- ======================================================================
--  УРОВЕНЬ 4 — САЙБЕРЛИМФА
-- ======================================================================

INSERT INTO teams (id, name, parent_id, leader_employee_id) VALUES
('018f3c80-8b4f-7b11-b403-e3f1a7087718', 'Отдел разработки',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776706', '018f3c80-8b4f-7b11-b403-e3f1a7087809'),

('018f3c80-8b4f-7b11-b403-e3f1a7087719', 'Коммерческий департамент',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776706', '018f3c80-8b4f-7b11-b403-e3f1a7087810'),

('018f3c80-8b4f-7b11-b403-e3f1a7087720', 'Лаборатория кибербезопасности',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776706', '018f3c80-8b4f-7b11-b403-e3f1a7087811');



-- ======================================================================
--  УРОВЕНЬ 4 — ВИТРОПС
-- ======================================================================

INSERT INTO teams (id, name, parent_id, leader_employee_id) VALUES
('018f3c80-8b4f-7b11-b403-e3f1a7087721', 'Администрация',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776707', '018f3c80-8b4f-7b11-b403-e3f1a7087812'),

('018f3c80-8b4f-7b11-b403-e3f1a7087722', 'Отдел персонала',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776707', '018f3c80-8b4f-7b11-b403-e3f1a7087813'),

('018f3c80-8b4f-7b11-b403-e3f1a7087723', 'Планово-экономический отдел',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776707', '018f3c80-8b4f-7b11-b403-e3f1a7087814'),

('018f3c80-8b4f-7b11-b403-e3f1a7087724', 'Отдел поддержки 1С',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776707', '018f3c80-8b4f-7b11-b403-e3f1a7087815'),

('018f3c80-8b4f-7b11-b403-e3f1a7087725', 'Отдел кадрового делопроизводства',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776707', '018f3c80-8b4f-7b11-b403-e3f1a7087816'),

('018f3c80-8b4f-7b11-b403-e3f1a7087726', 'Служба внутреннего сервиса',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776707', '018f3c80-8b4f-7b11-b403-e3f1a7087817'),

('018f3c80-8b4f-7b11-b403-e3f1a7087727', 'Отдел делопроизводства',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776707', '018f3c80-8b4f-7b11-b403-e3f1a7087818'),

('018f3c80-8b4f-7b11-b403-e3f1a7087728', 'Бухгалтерия',
 '018f3c80-8b4e-7f63-b2ed-8e91bd776707', '018f3c80-8b4f-7b11-b403-e3f1a7087819');

-- ======================================================================
--  УРОВЕНЬ 5 — САЙБЕРЛИМФА → ОТДЕЛ РАЗРАБОТКИ
-- ======================================================================

INSERT INTO teams (id, name, parent_id, leader_employee_id) VALUES
('018f3c80-8b50-7e12-8c00-ba41bb887701', 'Группа серверной разработки',
 '018f3c80-8b4f-7b11-b403-e3f1a7087718', '018f3c80-8b50-7e12-8c00-ba41bb8877f1'),

('018f3c80-8b50-7e12-8c00-ba41bb887702', 'Группа веб-разработки',
 '018f3c80-8b4f-7b11-b403-e3f1a7087718', '018f3c80-8b50-7e12-8c00-ba41bb8877f2'),

('018f3c80-8b50-7e12-8c00-ba41bb887703', 'Группа аналитики',
 '018f3c80-8b4f-7b11-b403-e3f1a7087718', '018f3c80-8b50-7e12-8c00-ba41bb8877f3'),

('018f3c80-8b50-7e12-8c00-ba41bb887704', 'Группа администрирования проектов',
 '018f3c80-8b4f-7b11-b403-e3f1a7087718', '018f3c80-8b50-7e12-8c00-ba41bb8877f4'),

('018f3c80-8b50-7e12-8c00-ba41bb887705', 'Группа продуктового дизайна',
 '018f3c80-8b4f-7b11-b403-e3f1a7087718', '018f3c80-8b50-7e12-8c00-ba41bb8877f5');

-- ======================================================================
--  УРОВЕНЬ 5 — САЙБЕРЛИМФА → ЛАБОРАТОРИЯ КИБЕРБЕЗОПАСНОСТИ
-- ======================================================================

INSERT INTO teams (id, name, parent_id, leader_employee_id) VALUES
('018f3c80-8b50-7e12-8c00-ba41bb887706', 'Группа тестирования на проникновение',
 '018f3c80-8b4f-7b11-b403-e3f1a7087720', '018f3c80-8b50-7e12-8c00-ba41bb8877f6'),

('018f3c80-8b50-7e12-8c00-ba41bb887707', 'Группа мониторинга ИБ',
 '018f3c80-8b4f-7b11-b403-e3f1a7087720', '018f3c80-8b50-7e12-8c00-ba41bb8877f7'),

('018f3c80-8b50-7e12-8c00-ba41bb887708', 'Группа разработки средств защиты',
 '018f3c80-8b4f-7b11-b403-e3f1a7087720', '018f3c80-8b50-7e12-8c00-ba41bb8877f8'),

('018f3c80-8b50-7e12-8c00-ba41bb887709', 'Группа анализа инцидентов ИБ',
 '018f3c80-8b4f-7b11-b403-e3f1a7087720', '018f3c80-8b50-7e12-8c00-ba41bb8877f9');

-- INSERT INTO teams (id, name, parent_id, leader_employee_id)
-- VALUES
--     ('3f5c1b10-0000-0000-0000-000000000001', 'Правление', NULL, '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d106'),
--     ('3f5c1b10-0000-0000-0000-000000000002', 'Продуктовый офис', '3f5c1b10-0000-0000-0000-000000000001', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d105'),
--     ('3f5c1b10-0000-0000-0000-000000000003', 'UX Studio', '3f5c1b10-0000-0000-0000-000000000002', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d101'),
--     ('3f5c1b10-0000-0000-0000-000000000004', 'Инженерный блок', '3f5c1b10-0000-0000-0000-000000000001', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d104'),
--     ('3f5c1b10-0000-0000-0000-000000000005', 'Backend Guild', '3f5c1b10-0000-0000-0000-000000000004', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d102'),
--     ('3f5c1b10-0000-0000-0000-000000000006', 'Клиентские сервисы', '3f5c1b10-0000-0000-0000-000000000001', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d103')
-- ON CONFLICT (id) DO NOTHING;






-- ===== 3) EMPLOYEES =====
-- Фиксированные UUID для позиций (можешь поменять на свои)
INSERT INTO employees (
    id,
    first_name,
    middle_name,
    last_name,
    birth_date,
    hire_date,
    city,
    email,
    phone,
    mattermost,
    tg,
    about_me,
    legal_entity,
    department,
    team_id,
    position_id
)
VALUES
    ('7a347577-1e7c-4a9a-b6a6-b7f4e2a9d101', 'Анастасия', 'Сергеевна', 'Иванова', '1995-03-04', '2018-01-15', 'Екатеринбург', 'an.ivanova@udv.com', '+7 (922) 555-13-37', 'anastasia.ivanova', '@ivanova_ui', 'Люблю продуманные интерфейсы, готую альтернативные рецепты кофе и катаюсь на сноуборде по выходным.', 'ФТ-СОФТ', 'Отдел продуктовой разработки 2', '018f3c80-8b4f-7b11-b403-e3f1a7087706', '0f5d5d50-0000-0000-0000-000000000003'),
    ('7a347577-1e7c-4a9a-b6a6-b7f4e2a9d102', 'Алексей', 'Дмитриевич', 'Сергеев', '1991-07-22', '2015-04-01', 'Пермь', 'alexey.sergeev@udv.com', '+7 (912) 730-45-20', 'alexey.sergeev', '@sergeev_backend', 'Веду backend-гильдию и менторю молодых разработчиков. Свободное время посвящаю бегу и барбекю.', 'ФТ-СОФТ', 'Основное подразделение', '018f3c80-8b4f-7b11-b403-e3f1a7087708', '0f5d5d50-0000-0000-0000-000000000004'),
    ('7a347577-1e7c-4a9a-b6a6-b7f4e2a9d103', 'Марина', 'Олеговна', 'Петрова', '1993-11-15', '2019-05-20', 'Москва', 'marina.petrova@udv.com', '+7 (999) 412-00-78', 'marina.petrova', NULL, 'Строю долгосрочные отношения с клиентами и организую совместные мероприятия.', 'ФТ-СОФТ', 'Направление аналитики и документации', '018f3c80-8b4f-7b11-b403-e3f1a7087709', '0f5d5d50-0000-0000-0000-000000000006'),
    ('7a347577-1e7c-4a9a-b6a6-b7f4e2a9d104', 'Константин', 'Андреевич', 'Трофимов', '1986-01-12', '2010-08-10', 'Санкт-Петербург', 'konstantin.trofimov@udv.com', NULL, 'konstantin.trofimov', '@cto_konstantin', 'Люблю сложные технические задачи, модерирую архитектурные комитеты и бегаю марафоны.', 'ФТ-СОФТ', 'Отдел заказной разработки', '018f3c80-8b4f-7b11-b403-e3f1a7087707', '0f5d5d50-0000-0000-0000-000000000005'),
    ('7a347577-1e7c-4a9a-b6a6-b7f4e2a9d105', 'Мария', 'Юрьевна', 'Котова', '1989-09-03', '2012-03-05', 'Екатеринбург', 'maria.kotova@udv.com', '+7 (921) 650-13-90', 'maria.kotova', '@teamlead_maria', 'Отвечаю за стратегию продуктового портфеля и поддерживаю команды в развитии гипотез.', 'ФТ-СОФТ', 'Отдел продуктовой разработки 1', '018f3c80-8b4f-7b11-b403-e3f1a7087705', '0f5d5d50-0000-0000-0000-000000000002'),
    ('7a347577-1e7c-4a9a-b6a6-b7f4e2a9d106', 'Виктор', 'Сергеевич', 'Дьяконов', '1982-05-08', '2006-02-01', 'Москва', 'victor.dyakov@udv.com', '+7 (921) 555-00-01', 'victor.dyakov', NULL, 'Строю экосистему продуктов и развиваю цифровую культуру. В свободное время увлекаюсь яхтингом.', 'ФТ-СОФТ', 'Администрация', '018f3c80-8b4f-7b11-b403-e3f1a7087704', '0f5d5d50-0000-0000-0000-000000000001')
ON CONFLICT (id) DO NOTHING;

-- ===== 4) STATUS HISTORY =====
INSERT INTO status_history (id, employee_id, status, started_at, ended_at)
VALUES ('10000000-0000-0000-0000-000000000101', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d101', 'active',
        '2023-01-09T09:00:00+00', NULL),
       ('10000000-0000-0000-0000-000000000102', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d102', 'sickLeave',
        '2025-02-03T09:00:00+00', NULL),
       ('10000000-0000-0000-0000-000000000103', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d103', 'active',
        '2022-09-12T09:00:00+00', NULL),
       ('10000000-0000-0000-0000-000000000104', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d104', 'vacation',
        '2025-08-01T09:00:00+00', NULL),
       ('10000000-0000-0000-0000-000000000105', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d105', 'active',
        '2020-06-15T09:00:00+00', NULL),
       ('10000000-0000-0000-0000-000000000106', '7a347577-1e7c-4a9a-b6a6-b7f4e2a9d106', 'active',
        '2006-02-01T09:00:00+00', NULL) ON CONFLICT (id) DO NOTHING;


-- ===== 5) USERS (учётки для аутентификации) =====
INSERT INTO users (id, email, password_hash, role)
VALUES ('22222222-0000-0000-0000-000000000001', 'victor.dyakov@udv.com',
        '$2b$12$g7L2E8sMYeY8WcZWxV1S6e5y6iS.UJv2sZ2VZfSxH1ZQ0hQeYbB9m', 'admin'),
       ('22222222-0000-0000-0000-000000000002', 'an.ivanova@udv.com',
        '$2b$12$g7L2E8sMYeY8WcZWxV1S6e5y6iS.UJv2sZ2VZfSxH1ZQ0hQeYbB9m',
        'user') -- DevOps Engineer (тимлида нет — ставим его же)
    ON CONFLICT (id) DO NOTHING;

-- Возвращаем проверку ограничений в исходное состояние для транзакции
SET LOCAL session_replication_role = 'origin';
COMMIT;
